- step:
    name: properties-fixed-dataset-version
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    command:
      - uv venv
      - source .venv/bin/activate
      - uv pip install -r requirements.txt
      - python output_metadata/same_dataset_version.py {parameters}
    parameters:
      - name: nr_of_files
        default: 10
        optional: false
        type: integer
- step:
    name: exec-info
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    command:
      - uv init
      - uv add -r requirements.txt
      - uv run execution-info/print_execution_info.py {parameters}
- step:
    name: exec-config
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    command:
      - uv venv
      - source .venv/bin/activate
      - uv pip install -r requirements.txt
      # until config support is available, vendor in a dev version of the utils library
      - tar xfz ./valohai-utils.tgz
      - UV_LINK_MODE=copy uv pip install -e valohai-utils
      - python execution-info/get_execution_config.py {parameters}
- step:
    name: run-for-limited-time
    image: ghcr.io/astral-sh/uv:python3.12-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - source .venv/bin/activate
      - python execution_timeout/run_for_given_time.py {parameters}
    parameters:
      - name: duration
        default: 120
        optional: false
        type: integer
    time-limit: 20
- step:
    name: create-output-files
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - uv add humanfriendly
      - uv add faker
      - uv run python create_output_files/create_files.py {parameters}
    parameters:
      - name: nr_of_files
        default: 1
        type: integer
      - name: file_size
        default: 1KiB
        type: string
- step:
    name: create-dataset-with-invalid-name
    description: |
      This step is used to test the validation of dataset names.
      It should fail with an error about invalid characters in the name.
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - uv run python create_dataset/create_dataset_with_invalid_name.py
- step:
    name: log-inputs
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - uv run python log_inputs/log_inputs.py
    inputs:
      - name: input_data
        optional: false
        keep-directories: full
- step:
    name: run-with-no-output-timeout
    image: python:3.11-slim
    no-output-timeout: 5
    command:
      - pip install -r requirements.txt
      - python execution_timeout/run_until_no_output_timeout.py {parameters}
    parameters:
      - name: duration
        default: 5
        optional: false
        type: integer
- step:
    name: step with python 3.13 image
    image: python:3.13
    command:
      - python --version

# simple pipeline -- wrap a single execution with parameter in a pipeline node
# model pipeline -- two nodes, one with parameter and one with model input parameter
- step:
    name: pipeline-hello
    image: python:3.13-slim-bookworm
    command:
      - python ./simple_pipeline/hello-with-parameter.py {parameters}
    parameters:
      - name: "name"
        type: string
        default: "Valohai"
        # description: "The name to greet."
# lists contents of a model, can take model as input or parameter
- step:
    name: list-model-contents
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - uv run python model_pipeline/list_model_contents.py {parameters}
    parameters:
      - name: model_url
        type: string
        optional: true
        # default: model://test-model/1
        # description: "The model URL to list contents of."
    inputs:
      - name: model
        default: "{parameter:model_url}"
        optional: false

- pipeline:
    name: simple-pipeline
    parameters:
      - name: "greet-name"
        targets:
          - hello-node.parameters.name
        default: "Valohai pipeline"
    nodes:
      - name: hello-node
        type: execution
        step: pipeline-hello
    edges: [ ]
- pipeline:
    name: model-pipeline
    nodes:
      - name: greet-node
        type: execution
        step: pipeline-hello
      - name: list-model-node
        type: execution
        step: list-model-contents
    parameters:
      - name: greet-name
        targets:
          - greet-node.parameters.name
        default: "Valohai model pipeline"
      - name: model
        targets:
          - list-model-node.parameters.model_url
        default: model://test-model/1
    edges: [ ]


# model and input pipeline -- two nodes, one takes a model URL as input and the other a datum URL
# there is also another, optional, datum input (to test default behaviour)
- step:
    name: list-datum-data
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv init
      - uv add valohai-utils
      - uv run python model_pipeline/list_datum_data.py
    inputs:
      - name: datum
        description: Any datum will do
        optional: false
      - name: optional_datum
        description: You can add another
        optional: true
- pipeline:
    name: model-and-input-pipeline
    nodes:
      - name: list-model-input-node
        type: execution
        step: list-model-contents
        on-error: continue
      - name: list-datum-data-node
        type: execution
        step: list-datum-data
        on-error: continue
    edges: [ ]

# dynamic input handling -- does not load the actual input files if only metadata is handled
- step:
    name: get-dynamic-input-metadata
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv run python metadata-without-download/show-input-metadata.py
    inputs:
      - name: input_files
        default: datum://01981d62-3dff-68d7-2050-b49d5dd8a1b6
        download: on-demand
# process input files and update metadata property if it does already exist
- step:
    name: update-input-properties
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - uv run
        --with httpx
        python update_metadata_properties/update_properties.py
    inputs:
      - name: input_files
        download: on-demand
        default: datum://01981d62-3dff-68d7-2050-b49d5dd8a1b6

# test calling the valohai API from an execution
- step:
    name: call-api
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - PYTHONPATH=.
        uv run
        --with valohai-utils
        --with httpx
        call_api/test_api_call.py

# Pipeline with two steps that have a parameter with the same name
# For testing passing workflow parameters to the correct node
- pipeline:
    name: steps-with-similar-params
    nodes:
      - name: node-with-name-and-date
        type: execution
        step: name-and-date
      - name: node-with-name-and-number
        type: execution
        step: name-and-number
    edges: [ ]
- step:
    name: name-and-date
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - echo 'Name - {parameter-value:name}'
      - echo 'Date - {parameter-value:date}'
    parameters:
      - name: name
        type: string
        default: "Unknown"
      - name: date
        type: string
        default: "0000-00-00"
- step:
    name: name-and-number
    image: ghcr.io/astral-sh/uv:python3.13-bookworm-slim
    command:
      - echo 'Name   - {parameter-value:name}'
      - echo 'Number - {parameter-value:number}'
    parameters:
      - name: name
        type: string
        default: "No name"
      - name: number
        type: integer
        default: 0
